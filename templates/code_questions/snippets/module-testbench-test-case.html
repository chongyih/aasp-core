{% load static %}

<div>
    <!-- test cases & code snippet management forms -->
    {{ testcase_formset.management_form }}

    <!-- Sample Test case -->
    <h5>Sample Test Case</h5>
    {% include 'code_questions/snippets/double-hdl-test-case-row.html' with sample=True prefix_1="0" prefix_2="1" form_1=testcase_formset.0 form_2=testcase_formset.1 sol_form=hdl_solution_form %}
    <!-- this div holds all internal test case rows -->
    <h5>Internal Test Cases</h5>
    <div id="test-cases-container" class="mt-4">
    {% for f in testcase_formset|slice:"2:" %}
        {% include 'code_questions/snippets/hdl-test-case-row.html' with prefix=forloop.counter|add:1 form=f %}
    {% endfor %}
    </div>

</div>

{% block js %}
    <script type="text/javascript" src="{% static 'vendors/toastify/toastify.js' %}"></script>

    <!-- Error message toast -->
    <script>
        const showErrorToast = (msg) => {
            Toastify({
                text: msg,
                duration: 3000,
                position: "center",
                style: {"background": "#ff6961"}
            }).showToast();
        };
    </script>

    <script>
        const langSelect = $("#lang-select");
        const defaultModuleCode = $('option:first', langSelect).data('code');
        const defaultTBCode = $('option:eq(1)', langSelect).data('code');

        const initialize_editor = (editor, idx) => {
            editor.renderer.setScrollMargin(10);

            editor.setOptions({
                fontFamily: "JetBrains Mono",
                fontSize: "16px",
                theme: "ace/theme/cloud9_day",
                showPrintMargin: false,
                highlightActiveLine: false,
                wrap: true,
                tabSize: 4,
            });

            editor.setOption("dragEnabled", false);
            editor.session.setMode("ace/mode/" + $("#lang-select").find("option:selected").data('ace-mode'));

            // get the default code
            const defaultCode = idx == 0 ? defaultModuleCode : defaultTBCode; // module code for first editor, testbench code for rest

            // get the solution code
            const stdin = $(`#id_tc-${idx}-stdin`).val() ? $(`#id_tc-${idx}-stdin`).val() : defaultCode;

            // set the code snippet
            editor.session.setValue(stdin);
            document.getElementById(`id_tc-${idx}-stdin`).value = stdin;

            // Synchronize Ace editor content with the hidden input field
            editor.getSession().on('change', function(){
                var code = editor.getValue();
                document.getElementById(`id_tc-${idx}-stdin`).value = code;
            });
        }

        for (let i = 0; i < $("#id_tc-TOTAL_FORMS").val(); i++) {
            let editor = ace.edit(`id_tc-${i}-stdin-editor`);

            initialize_editor(editor, i);
        }

        const generateTestbench = (elem) => {
            const index = elem.id.replace("id_tc-", "").replace("-gen-tb", "");
            
            const module_code = document.getElementById(`id_tc-${index}-stdin`).value;

            $(document).ready(function() {
                    $.ajax({
                        type: "POST",
                        url: "/testbench/generate/",
                        data: {
                            csrfmiddlewaretoken: "{{ csrf_token }}",
                            module_code: module_code,
                        },
                    }).done((res, textStatus, jqXHR) => {
                        let testbench_editor = ace.edit(`id_tc-${Number(index) + 1}-stdin-editor`);
                        testbench_editor.setValue(res.testbench, -1);
                    }).fail((jqXHR, textStatus, errorThrown) => {
                        // 4xx status codes
                        if (Math.floor(jqXHR.status / 100) == 4) {
                            showErrorToast(jqXHR.responseJSON.message);
                        }
                        else {
                            showErrorToast("Something went wrong. Please try again.");
                        }
                    });
                })
            }
        
    </script>
{% endblock %}